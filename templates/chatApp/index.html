{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Web con Login, Productos y Carrito</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" type="image/x-icon" href="{% static 'images/icon/favicon.png' %}">
  <link rel="stylesheet" href="{% static 'css/chat.css' %}">
  <style>
    body { margin-top: 40px; font-family: Arial, sans-serif; background:#f4f4f4; }

    /* Topbar */
    .topbar { position: fixed; top:0; right:0; width:100%; height:40px; background:#222; color:#fff;
              display:flex; justify-content:flex-end; align-items:center; padding-right:10px; z-index:1000; }
    .menu-btn { background:none; border:none; color:#fff; font-size:20px; cursor:pointer; padding:4px 8px; }
    .menu-dropdown { display:none; position:absolute; top:40px; right:10px; background:#333; border-radius:6px;
                     min-width:140px; box-shadow:0 2px 6px rgba(0,0,0,0.3); }
    .menu-dropdown.active { display:block; }
    .menu-dropdown button { width:100%; padding:10px; background:none; border:none; color:#fff;
                            text-align:left; cursor:pointer; font-size:14px; }
    .menu-dropdown button:hover { background:#444; }

    /* Productos */
    .product-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:16px;
                    padding:20px; margin-top:60px; }
    .product-card { background:#fff; border:1px solid #ccc; border-radius:10px; text-align:center; padding:10px;
                    box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    .product-card img { width:100%; height:140px; object-fit:cover; border-radius:8px; }
    .product-card h4 { margin:8px 0 4px; font-size:16px; }
    .product-card p { margin:4px 0; color:#333; font-size:14px; }
    .product-card button { background:#0078ff; color:#fff; border:none; padding:8px 10px;
                           border-radius:6px; cursor:pointer; }
    .product-card button:hover { background:#005ecc; }

    /* Carrito */
    .cart-popup { display:none; position:fixed; top:50px; right:10px; background:#fff; border-radius:6px;
                  padding:10px; box-shadow:0 2px 8px rgba(0,0,0,0.3); z-index:2000; min-width:200px; }
    .cart-popup.active { display:block; }
  .cart-popup .close-btn { position:absolute; top:6px; right:8px; background:#f0f0f0; border:none;
               border-radius:4px; padding:4px 6px; cursor:pointer; font-weight:bold; }
  .cart-popup .close-btn:hover { background:#e0e0e0; }
    

    /* Chat */
    .chat-container { position:fixed; bottom:0; right:10px; width:300px; max-height:500px; background:#f5f5f5;
                      border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.3); display:flex; flex-direction:column; }
    .chat-header { background:#0078ff; color:#fff; padding:8px; font-weight:bold;
                   border-radius:10px 10px 0 0; text-align:center; }
    .messages { flex:1; overflow-y:auto; padding:8px; }
    .input-row { display:flex; padding:8px; gap:4px; }
    .input-row input { flex:1; padding:6px; border-radius:6px; border:1px solid #ccc; }
    .input-row button { padding:6px 10px; border:none; border-radius:6px; background:#0078ff;
                        color:#fff; cursor:pointer; }
  </style>
</head>
<body>

<!-- Topbar -->
<div class="topbar">
  <button class="menu-btn" id="menuBtn">☰</button>
  <div class="menu-dropdown" id="menuDropdown">
    <button id="cartBtn">Carrito</button>
    {% if user.is_authenticated %}
      <div style="padding:8px; color:#fff; font-size:14px;">Conectado como <strong>{{ user.username }}</strong></div>
      <button id="logoutBtn">Cerrar sesión</button>
    {% else %}
      <button id="loginBtn">Iniciar sesión</button>
      <button id="registerBtn">Registrarse</button>
    {% endif %}
  </div>
</div>

<!-- === PRODUCTOS FICTICIOS === -->
<div class="product-grid">
  <div class="product-card" data-id="1">
    <img src="{% static 'images/products/mouse.jpg' %}" alt="Mouse gamer">
    <h4>Mouse Gamer</h4>
    <p>$19.990</p>
    <button class="add-btn">Agregar al carrito</button>
  </div>
  <div class="product-card" data-id="2">
    <img src="{% static 'images/products/teclado.jpg' %}" alt="Teclado mecánico">
    <h4>Teclado Mecánico</h4>
    <p>$34.990</p>
    <button class="add-btn">Agregar al carrito</button>
  </div>
  <div class="product-card" data-id="3">
    <img src="{% static 'images/products/monitor.jpg' %}" alt="Monitor 144Hz">
    <h4>Monitor 144Hz</h4>
    <p>$179.990</p>
    <button class="add-btn">Agregar al carrito</button>
  </div>
  <div class="product-card" data-id="4">
    <img src="{% static 'images/products/audifonos.jpg' %}" alt="Audífonos">
    <h4>Audífonos</h4>
    <p>$24.990</p>
    <button class="add-btn">Agregar al carrito</button>
  </div>
  <div class="product-card" data-id="5">
    <img src="{% static 'images/products/silla.jpg' %}" alt="Silla gamer">
    <h4>Silla Gamer</h4>
    <p>$99.990</p>
    <button class="add-btn">Agregar al carrito</button>
  </div>
  <div class="product-card" data-id="6">
    <img src="{% static 'images/products/gpu.jpg' %}" alt="Tarjeta gráfica">
    <h4>Tarjeta Gráfica</h4>
    <p>$299.990</p>
    <button class="add-btn">Agregar al carrito</button>
  </div>
</div>

<!-- Carrito popup -->
<div class="cart-popup" id="cartPopup">
  <button id="cartCloseBtn" class="close-btn" aria-label="Cerrar carrito">✕</button>
  <h4>Carrito</h4>
  <ul id="cartItems"></ul>
</div>

<!-- Modal Login -->
<div id="loginModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
    background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.3); z-index:3000;">
  <form id="loginForm">
    <h3>Iniciar sesión</h3>
    <input type="text" id="loginUsername" placeholder="Usuario" required><br><br>
    <input type="password" id="loginPassword" placeholder="Contraseña" required><br><br>
    <button type="submit">Entrar</button>
    <button type="button" id="closeLogin">Cerrar</button>
  </form>
</div>

<!-- Modal Registro -->
<div id="registerModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
    background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.3); z-index:3000;">
  <form id="registerForm">
    <h3>Registrarse</h3>
    <input type="text" id="registerUsername" placeholder="Usuario" required><br><br>
    <input type="password" id="registerPassword" placeholder="Contraseña" required><br><br>
    <input type="password" id="registerPasswordConfirm" placeholder="Confirmar contraseña" required><br><br>
    <button type="submit">Registrar</button>
    <button type="button" id="closeRegister">Cerrar</button>
  </form>
</div>


<!-- Chat container -->
<div class="chat-container" id="chatContainer">
  <div class="chat-header">Chat Global</div>
  <div class="messages" id="messages"></div>
  <div class="input-row">
    <input type="text" id="msgInput" placeholder="Escribe un mensaje...">
    <button id="sendBtn">Enviar</button>
  </div>
</div>

<form id="csrf-form" style="display:none;">{% csrf_token %}</form>

<script>
/* === Utilidades CSRF === */
function getCSRFToken() {
  return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

/* === Menú === */
const menuBtn = document.getElementById('menuBtn');
const menuDropdown = document.getElementById('menuDropdown');
menuBtn.addEventListener('click', () => {
  menuDropdown.classList.toggle('active');
});

/* === Carrito === */
async function addToCart(productId) {
  try {
    const res = await fetch('/cart/add/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken(),
      },
      body: JSON.stringify({ product_id: productId, cantidad: 1 }),
    });
    if (res.status === 401) {
      // Not authenticated -> open login modal
      if (loginModal) loginModal.style.display = 'block';
      alert('Debes iniciar sesión para agregar al carrito');
      return;
    }
    const data = await res.json();
    if (res.ok && data.success) {
      alert('Producto agregado al carrito');
      await loadCart();
    } else {
      alert(data.error || 'Error al agregar al carrito');
    }
  } catch (err) {
    console.error(err);
  }
}

async function loadCart() {
  try {
    const res = await fetch('/cart/');
    if (res.status === 401) {
      if (loginModal) loginModal.style.display = 'block';
      return;
    }
    const data = await res.json();
    const ul = document.getElementById('cartItems');
    ul.innerHTML = '';
    data.items.forEach(item => {
      const li = document.createElement('li');
      li.textContent = `${item.nombre} (${item.cantidad}) - $${item.subtotal}`;
      ul.appendChild(li);
    });
  } catch (err) {
    console.error('Error loading cart', err);
  }
}

document.querySelectorAll('.add-btn').forEach(btn => {
  btn.addEventListener('click', e => {
    const id = e.target.closest('.product-card').dataset.id;
    addToCart(id);
  });
});

document.getElementById('cartBtn').addEventListener('click', () => {
  document.getElementById('cartPopup').classList.toggle('active');
  loadCart();
});
// Close button for cart popup
const cartCloseBtn = document.getElementById('cartCloseBtn');
if (cartCloseBtn) {
  cartCloseBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    document.getElementById('cartPopup').classList.remove('active');
  });
}


/* Chat: improved client (CSRF, avatars, tabs, datetime) */
/* leer cookie */
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

/* CSRF token: primero intenta cookie, si no existe, fallback leyendo el input hidden
  con name="csrfmiddlewaretoken" (el formulario oculto con {% csrf_token %} está en la plantilla) */
const _csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
let csrftoken = getCookie('csrftoken') || (_csrfInput ? _csrfInput.value : null);

/* si no existe inmediatamente, intenta actualizarlo después de un pequeño delay */
if (!csrftoken) {
  setTimeout(() => {
    try {
      const _delayedInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
      csrftoken = (typeof getCookie === 'function' ? getCookie('csrftoken') : null) || (_delayedInput ? _delayedInput.value : null);
      console.log('csrf token (delayed):', csrftoken);
    } catch (err) {
      console.warn('Error while trying to read delayed CSRF token:', err);
    }
  }, 50);
}

/* datetime */
function updateDateTime() {
  const now = new Date();
  const d = String(now.getDate()).padStart(2,'0');
  const m = String(now.getMonth()+1).padStart(2,'0');
  const y = now.getFullYear();
  const hh = String(now.getHours()).padStart(2,'0');
  const mm = String(now.getMinutes()).padStart(2,'0');
  const dtEl = document.getElementById('datetime');
  if (dtEl) dtEl.textContent = `${d}/${m}/${y} ${hh}:${mm}`;
}
updateDateTime();
setInterval(updateDateTime, 60000);

/* UI: tabs */
const tabs = document.querySelectorAll('.tab');
let activeTab = 'nacional';
tabs.forEach(t => t.addEventListener('click', () => {
  tabs.forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  activeTab = t.dataset.tab;
  loadMessages(activeTab);
}));

/* avatar picker */
let selectedAvatar = '';
document.querySelectorAll('.avatar-option').forEach(img=>{
  img.addEventListener('click', ()=> {
    document.querySelectorAll('.avatar-option').forEach(i=>i.classList.remove('selected'));
    img.classList.add('selected');
    selectedAvatar = img.dataset.src;
  });
});
const firstAvatar = document.querySelector('.avatar-option');
if (firstAvatar) { firstAvatar.classList.add('selected'); selectedAvatar = firstAvatar.dataset.src; }

/* append message to DOM */
function appendMessage(m){
  const container = document.getElementById('messages');
  const wrap = document.createElement('div');
  wrap.className = 'message';
  const icon = document.createElement('div');
  icon.className = 'icon';
  if (m.avatar) {
    const im = document.createElement('img');
    im.src = m.avatar;
    im.style.width = '100%'; im.style.height = '100%'; im.style.objectFit = 'cover';
    icon.appendChild(im);
  } else {
    icon.textContent = '👤';
  }
  const txt = document.createElement('div');
  txt.className = 'text';
  const senderHTML = m.sender ? `<div style="font-weight:600;margin-bottom:4px">${escapeHtml(m.sender)}</div>` : '';
  txt.innerHTML = `${senderHTML}<div style="font-size:11px;color:#666;margin-bottom:4px">${m.timestamp || ''}</div><div>${escapeHtml(m.text)}</div>`;
  wrap.appendChild(icon);
  wrap.appendChild(txt);
  container.appendChild(wrap);
  container.scrollTop = container.scrollHeight;
}

/* escape básico para evitar inyección HTML en mensajes */
function escapeHtml(unsafe) {
  return unsafe.replace(/[&<>\"']/g, function(m) {
    return ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;', "'":'&#039;'}[m]);
  });
}

/* cargar mensajes desde API */
async function loadMessages(tab){
  try {
    const res = await fetch('/messages/?tab=' + encodeURIComponent(tab));
    if (!res.ok) throw new Error('No se pudieron cargar mensajes');
    const data = await res.json();
    const messagesEl = document.getElementById('messages');
    if (messagesEl) messagesEl.innerHTML = '';
    data.messages.forEach(m => appendMessage(m));
  } catch(e) {
    console.error(e);
  }
}

/* enviar mensaje */
async function sendMessage(){
  const input = document.getElementById('msgInput');
  const text = input?.value.trim();
  if (!text) return;
  // refresh csrf token if missing
  csrftoken = csrftoken || getCookie('csrftoken') || document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || null;
  try {
    const res = await fetch('/messages/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken
      },
      body: JSON.stringify({ text: text, tab: activeTab, avatar: selectedAvatar, sender: ("{% if user.is_authenticated %}{{ user.username }}{% else %}{% endif %}") })
    });
    if (!res.ok) {
      const textErr = await res.text().catch(()=>null);
      throw new Error('Server error: ' + (textErr || res.status));
    }
    const data = await res.json();
    appendMessage(data.message);
    if (input) input.value = '';
  } catch (err) {
    alert('No se pudo enviar el mensaje.');
    console.error(err);
  }
}

const sendBtn = document.getElementById('sendBtn');
const msgInput = document.getElementById('msgInput');
if (sendBtn) sendBtn.addEventListener('click', sendMessage);
if (msgInput) msgInput.addEventListener('keypress', (e)=> { if (e.key === 'Enter') sendMessage(); });

/* inicial carga */
loadMessages(activeTab);
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');

  // --- LOGIN ---
  if (loginForm) {
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;

      try {
        const response = await fetch("{% url 'login' %}", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();
        if (data.success) {
          alert("Inicio de sesión exitoso ✅");
          location.reload();
        } else {
          alert(data.error || "Error al iniciar sesión");
        }
      } catch (err) {
        console.error(err);
        alert("Error de conexión");
      }
    });
  }

  // --- REGISTRO ---
  if (registerForm) {
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('registerUsername').value;
      const password = document.getElementById('registerPassword').value;
      const passwordConfirm = document.getElementById('registerPasswordConfirm').value;

      if (password !== passwordConfirm) {
        alert('Las contraseñas no coinciden');
        return;
      }

      try {
        const response = await fetch("{% url 'register' %}", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();
        if (data.success) {
          // Intentar login automático después de registrarse
          try {
            const loginRes = await fetch("{% url 'login' %}", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ username, password })
            });
            const loginData = await loginRes.json();
            if (loginData.success) {
              alert("Registro y login exitoso ✅");
              location.reload();
            } else {
              alert("Registro exitoso. Por favor inicia sesión.");
              registerModal.style.display = 'none';
            }
          } catch (err) {
            console.error('Auto-login failed', err);
            alert('Registro exitoso. Por favor inicia sesión.');
            registerModal.style.display = 'none';
          }
        } else {
          alert(data.error || "Error al registrarse");
        }
      } catch (err) {
        console.error(err);
        alert("Error de conexión");
      }
    });
  }
});
</script>
<script>
const loginBtn = document.getElementById('loginBtn');
const registerBtn = document.getElementById('registerBtn');
const loginModal = document.getElementById('loginModal');
const registerModal = document.getElementById('registerModal');
const closeLogin = document.getElementById('closeLogin');
const closeRegister = document.getElementById('closeRegister');
const logoutBtn = document.getElementById('logoutBtn');

if (loginBtn) loginBtn.addEventListener('click', () => loginModal.style.display = 'block');
if (registerBtn) registerBtn.addEventListener('click', () => registerModal.style.display = 'block');
if (closeLogin) closeLogin.addEventListener('click', () => loginModal.style.display = 'none');
if (closeRegister) closeRegister.addEventListener('click', () => registerModal.style.display = 'none');
if (logoutBtn) {
  logoutBtn.addEventListener('click', async () => {
    try {
      await fetch("{% url 'logout' %}", { method: 'POST' });
      location.reload();
    } catch (err) {
      console.error(err);
      alert('Error al cerrar sesión');
    }
  });
}
</script>


</body>
</html>
