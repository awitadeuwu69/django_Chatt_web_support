{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Chat Global</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" type="image/x-icon" href="{% static 'images/icon/favicon.png' %}">
  <link rel="stylesheet" href="{% static 'css/chat.css' %}">
  <style>

  </style>
</head>
<body>

<div class="chat-container" id="chatContainer" role="dialog" aria-label="Chat">
  <button id="close-chat" class="close-btn">âœ–</button>
  <div class="chat-header">
    Chat Global
    <div id="datetime" style="font-size:12px;opacity:.9;margin-top:4px"></div>
  </div>

  

  <div class="tabs" id="tabs">
    <div class="tab active" data-tab="nacional">Nacional</div>
    <div class="tab" data-tab="local">Local</div>
    <div class="tab" data-tab="soporte">Soporte</div>
  </div>

  <div class="messages" id="messages"></div>

  <div class="input-row">
    <input type="text" id="msgInput" placeholder="Escribe un mensaje...">
    <button id="sendBtn">Enviar</button>
  </div>

  <div class="avatars" id="avatars">
    {# 'avatars' debe ser una lista de URLs (por ejemplo vistas con static(...) en la view) #}
    {% for avatar in avatars %}
      <img src="{{ avatar }}" class="avatar-option" data-src="{{ avatar }}" alt="avatar">
    {% endfor %}
  </div>
</div>

{# form oculto SÃ“LO para generar el token (no lo cargues con {% load csrf_token %}) #}
<form id="csrf-form" style="display:none;">
  {% csrf_token %}
</form>

<script>
/* leer cookie */
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

/* CSRF token: primero intenta cookie, si no existe, fallback leyendo el input generado por {% csrf_token %} */
let csrftoken = getCookie('csrftoken') || (document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || null);

/* si no existe inmediatamente, intenta actualizarlo despuÃ©s de un pequeÃ±o delay
   (esto ayuda si la cookie aÃºn no se estableciÃ³ en la primera carga) */
if (!csrftoken) {
  setTimeout(() => {
    csrftoken = getCookie('csrftoken') || (document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || null);
    console.log('csrf token (delayed):', csrftoken);
  }, 50);
}

/* datetime */
function updateDateTime() {
  const now = new Date();
  const d = String(now.getDate()).padStart(2,'0');
  const m = String(now.getMonth()+1).padStart(2,'0');
  const y = now.getFullYear();
  const hh = String(now.getHours()).padStart(2,'0');
  const mm = String(now.getMinutes()).padStart(2,'0');
  document.getElementById('datetime').textContent = `${d}/${m}/${y} ${hh}:${mm}`;
}
updateDateTime();
setInterval(updateDateTime, 60000);

/* UI: tabs */
const tabs = document.querySelectorAll('.tab');
let activeTab = 'nacional';
tabs.forEach(t => t.addEventListener('click', () => {
  tabs.forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  activeTab = t.dataset.tab;
  loadMessages(activeTab);
}));

/* avatar picker */
let selectedAvatar = '';
document.querySelectorAll('.avatar-option').forEach(img=>{
  img.addEventListener('click', ()=> {
    document.querySelectorAll('.avatar-option').forEach(i=>i.classList.remove('selected'));
    img.classList.add('selected');
    selectedAvatar = img.dataset.src;
  });
  // auto select first avatar if none selected
});
const firstAvatar = document.querySelector('.avatar-option');
if (firstAvatar) { firstAvatar.classList.add('selected'); selectedAvatar = firstAvatar.dataset.src; }

/* append message to DOM */
function appendMessage(m){
  const container = document.getElementById('messages');
  const wrap = document.createElement('div');
  wrap.className = 'message';
  const icon = document.createElement('div');
  icon.className = 'icon';
  if (m.avatar) {
    const im = document.createElement('img');
    im.src = m.avatar;
    im.style.width = '100%'; im.style.height = '100%'; im.style.objectFit = 'cover';
    icon.appendChild(im);
  } else {
    icon.textContent = 'ðŸ‘¤';
  }
  const txt = document.createElement('div');
  txt.className = 'text';
  txt.innerHTML = `<div style="font-size:11px;color:#666;margin-bottom:4px">${m.timestamp || ''}</div><div>${escapeHtml(m.text)}</div>`;
  wrap.appendChild(icon);
  wrap.appendChild(txt);
  container.appendChild(wrap);
  container.scrollTop = container.scrollHeight;
}

/* escape bÃ¡sico para evitar inyecciÃ³n HTML en mensajes */
function escapeHtml(unsafe) {
  return unsafe.replace(/[&<>"']/g, function(m) {
    return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#039;'}[m]);
  });
}

/* cargar mensajes desde API */
async function loadMessages(tab){
  try {
    const res = await fetch("{% url 'chatApp:messages_api' %}?tab=" + encodeURIComponent(tab));
    if (!res.ok) throw new Error('No se pudieron cargar mensajes');
    const data = await res.json();
    document.getElementById('messages').innerHTML = '';
    data.messages.forEach(m => appendMessage(m));
  } catch(e) {
    console.error(e);
  }
}

/* enviar mensaje */
async function sendMessage(){
  const input = document.getElementById('msgInput');
  const text = input.value.trim();
  if (!text) return;
  // refresh csrf token if missing
  csrftoken = csrftoken || getCookie('csrftoken') || document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || null;
  try {
    const res = await fetch("{% url 'chatApp:messages_api' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken
      },
      body: JSON.stringify({ text: text, tab: activeTab, avatar: selectedAvatar })
    });
    if (!res.ok) {
      const textErr = await res.text().catch(()=>null);
      throw new Error('Server error: ' + (textErr || res.status));
    }
    const data = await res.json();
    appendMessage(data.message);
    input.value = '';
  } catch (err) {
    alert('No se pudo enviar el mensaje.');
    console.error(err);
  }
}

document.getElementById('sendBtn').addEventListener('click', sendMessage);
document.getElementById('msgInput').addEventListener('keypress', (e)=> { if (e.key === 'Enter') sendMessage(); });

/* inicial carga */
loadMessages(activeTab);
</script>

</body>
</html>
