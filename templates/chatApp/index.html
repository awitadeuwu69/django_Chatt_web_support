{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Web con Login y Carrito</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" type="image/x-icon" href="{% static 'images/icon/favicon.png' %}">
  <link rel="stylesheet" href="{% static 'css/chat.css' %}">
  <style>
    body { margin-top: 40px; font-family: Arial, sans-serif; }
    /* Topbar */
    .topbar { position: fixed; top:0; right:0; width:100%; height:40px; background:#222; color:#fff; display:flex; justify-content:flex-end; align-items:center; padding-right:10px; z-index:1000; }
    .menu-btn { background:none; border:none; color:#fff; font-size:20px; cursor:pointer; padding:4px 8px; }
    .menu-dropdown { display:none; position:absolute; top:40px; right:10px; background:#333; border-radius:6px; min-width:140px; box-shadow:0 2px 6px rgba(0,0,0,0.3); }
    .menu-dropdown.active { display:block; }
    .menu-dropdown button { width:100%; padding:10px; background:none; border:none; color:#fff; text-align:left; cursor:pointer; font-size:14px; }
    .menu-dropdown button:hover { background:#444; }
    /* Login/Register popup */
    .login-popup { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; padding:20px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.3); width:280px; z-index:2000; }
    .login-popup.active { display:block; }
    .login-popup h3 { text-align:center; margin-top:0; }
    .login-popup input { width:100%; padding:8px; margin:6px 0; border:1px solid #ccc; border-radius:6px; }
    .login-popup button { width:100%; padding:8px; border:none; background:#0078ff; color:#fff; border-radius:6px; cursor:pointer; margin-top:8px; }
    .login-popup button:hover { background:#005ecc; }
    /* Carrito */
    .cart-popup { display:none; position:fixed; top:50px; right:10px; background:#fff; border-radius:6px; padding:10px; box-shadow:0 2px 8px rgba(0,0,0,0.3); z-index:2000; min-width:200px; }
    .cart-popup.active { display:block; }
    /* Chat */
    .chat-container { position:fixed; bottom:0; right:10px; width:300px; max-height:500px; background:#f5f5f5; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.3); display:flex; flex-direction:column; }
    .chat-header { background:#0078ff; color:#fff; padding:8px; font-weight:bold; border-radius:10px 10px 0 0; text-align:center; }
    .messages { flex:1; overflow-y:auto; padding:8px; }
    .input-row { display:flex; padding:8px; gap:4px; }
    .input-row input { flex:1; padding:6px; border-radius:6px; border:1px solid #ccc; }
    .input-row button { padding:6px 10px; border:none; border-radius:6px; background:#0078ff; color:#fff; cursor:pointer; }
    .avatars { display:flex; padding:4px; justify-content:center; gap:4px; }
    .avatar-option { width:32px; height:32px; border-radius:50%; cursor:pointer; border:2px solid transparent; }
    .avatar-option.selected { border-color:#0078ff; }
    .message { display:flex; gap:6px; margin-bottom:6px; }
    .message .icon { width:36px; height:36px; border-radius:50%; overflow:hidden; background:#ccc; display:flex; align-items:center; justify-content:center; }
    .message .text { background:#eee; padding:4px 6px; border-radius:6px; flex:1; }
  </style>
</head>
<body>

<!-- Topbar -->
<div class="topbar">
  <button class="menu-btn" id="menuBtn">â˜°</button>
  <div class="menu-dropdown" id="menuDropdown">
    <button id="cartBtn">Carrito</button>
    <button id="loginBtn">Iniciar sesiÃ³n</button>
    <button id="registerBtn">Registrarse</button>
  </div>
</div>

<!-- Login popup -->
<div class="login-popup" id="loginPopup">
  <h3>Iniciar sesiÃ³n</h3>
  <input type="text" id="loginUser" placeholder="Usuario">
  <input type="password" id="loginPass" placeholder="ContraseÃ±a">
  <button id="confirmLogin">Entrar</button>
</div>

<!-- Register popup -->
<div class="login-popup" id="registerPopup">
  <h3>Registrarse</h3>
  <input type="text" id="regUser" placeholder="Usuario">
  <input type="password" id="regPass" placeholder="ContraseÃ±a">
  <input type="password" id="regPass2" placeholder="Repetir contraseÃ±a">
  <button id="confirmRegister">Registrar</button>
</div>

<!-- Carrito popup -->
<div class="cart-popup" id="cartPopup">
  <h4>Carrito</h4>
  <ul id="cartItems"></ul>
</div>

<!-- Chat container -->
<div class="chat-container" id="chatContainer">
  <div class="chat-header">
    Chat Global
    <div id="datetime" style="font-size:12px;opacity:.9;margin-top:4px"></div>
  </div>
  <div class="tabs" id="tabs">
    <div class="tab active" data-tab="nacional">Nacional</div>
    <div class="tab" data-tab="local">Local</div>
    <div class="tab" data-tab="soporte">Soporte</div>
  </div>
  <div class="messages" id="messages"></div>
  <div class="input-row">
    <input type="text" id="msgInput" placeholder="Escribe un mensaje...">
    <button id="sendBtn">Enviar</button>
  </div>
  <div class="avatars" id="avatars">
    {% for avatar in avatars %}
      <img src="{{ avatar }}" class="avatar-option" data-src="{{ avatar }}" alt="avatar">
    {% endfor %}
  </div>
</div>

<form id="csrf-form" style="display:none;">{% csrf_token %}</form>

<script>
/* === URLs API === */
const LOGIN_URL = "{% url 'login' %}";
const REGISTER_URL = "{% url 'register' %}";
const MESSAGES_URL = "{% url 'messages_api' %}";

/* === CSRF token === */
let csrftoken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || '';

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    document.cookie.split(';').forEach(cookie => {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) cookieValue = decodeURIComponent(cookie.substring(name.length+1));
    });
  }
  return cookieValue;
}

/* === Menu UI === */
const menuBtn = document.getElementById('menuBtn');
const menuDropdown = document.getElementById('menuDropdown');
const loginPopup = document.getElementById('loginPopup');
const registerPopup = document.getElementById('registerPopup');
const cartPopup = document.getElementById('cartPopup');

menuBtn.addEventListener('click', ()=> menuDropdown.classList.toggle('active'));
document.addEventListener('click', e => {
  if(!menuBtn.contains(e.target) && !menuDropdown.contains(e.target)) menuDropdown.classList.remove('active');
});
document.getElementById('loginBtn').addEventListener('click', ()=> { loginPopup.classList.toggle('active'); menuDropdown.classList.remove('active'); });
document.getElementById('registerBtn').addEventListener('click', ()=> { registerPopup.classList.toggle('active'); menuDropdown.classList.remove('active'); });
document.getElementById('cartBtn').addEventListener('click', ()=> { cartPopup.classList.toggle('active'); menuDropdown.classList.remove('active'); });

/* === Login/Register === */
document.getElementById('confirmLogin').addEventListener('click', async () => {
  const username = document.getElementById('loginUser').value.trim();
  const password = document.getElementById('loginPass').value.trim();
  if(!username || !password){ alert('Completa los campos'); return; }
  try {
    const res = await fetch(LOGIN_URL, { method:'POST', headers:{ 'Content-Type':'application/json','X-CSRFToken':csrftoken }, body: JSON.stringify({username,password}) });
    const data = await res.json();
    if(data.success){ alert('Login exitoso'); loginPopup.classList.remove('active'); }
    else alert(data.error||'Error en login');
  } catch(e){ console.error(e); alert('Error en la peticiÃ³n'); }
});

document.getElementById('confirmRegister').addEventListener('click', async () => {
  const username = document.getElementById('regUser').value.trim();
  const password = document.getElementById('regPass').value.trim();
  const password2 = document.getElementById('regPass2').value.trim();
  if(!username || !password || !password2){ alert('Completa todos los campos'); return; }
  if(password !== password2){ alert('Las contraseÃ±as no coinciden'); return; }
  try {
    const res = await fetch(REGISTER_URL, { method:'POST', headers:{ 'Content-Type':'application/json','X-CSRFToken':csrftoken }, body: JSON.stringify({username,password}) });
    const data = await res.json();
    if(data.success){ alert('Registro exitoso'); registerPopup.classList.remove('active'); }
    else alert(data.error||'Error en registro');
  } catch(e){ console.error(e); alert('Error en la peticiÃ³n'); }
});

/* === Chat === */
let activeTab = 'nacional';
let selectedAvatar = document.querySelector('.avatar-option')?.dataset.src || '';

document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', () => {
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  activeTab = t.dataset.tab;
  loadMessages(activeTab);
}));

document.querySelectorAll('.avatar-option').forEach(img => {
  img.addEventListener('click', () => {
    document.querySelectorAll('.avatar-option').forEach(i=>i.classList.remove('selected'));
    img.classList.add('selected');
    selectedAvatar = img.dataset.src;
  });
  if(!selectedAvatar){ img.classList.add('selected'); selectedAvatar = img.dataset.src; }
});

function escapeHtml(str) {
  return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}

function appendMessage(m){
  const container = document.getElementById('messages');
  const wrap = document.createElement('div');
  wrap.className = 'message';
  const icon = document.createElement('div'); icon.className='icon';
  if(m.avatar){ const im=document.createElement('img'); im.src=m.avatar; im.style.width='100%'; im.style.height='100%'; im.style.objectFit='cover'; icon.appendChild(im); }
  else icon.textContent='ðŸ‘¤';
  const txt = document.createElement('div'); txt.className='text';
  txt.innerHTML = `<div style="font-size:11px;color:#666;margin-bottom:4px">${m.timestamp||''}</div><div>${escapeHtml(m.text)}</div>`;
  wrap.appendChild(icon); wrap.appendChild(txt); container.appendChild(wrap); container.scrollTop=container.scrollHeight;
}

async function loadMessages(tab){
  try {
    const res = await fetch(`${MESSAGES_URL}?tab=${encodeURIComponent(tab)}`);
    if(!res.ok) throw new Error('No se pudieron cargar mensajes');
    const data = await res.json();
    document.getElementById('messages').innerHTML='';
    data.messages.forEach(m=>appendMessage(m));
  } catch(e){ console.error(e); }
}

async function sendMessage(){
  const input = document.getElementById('msgInput');
  const text = input.value.trim();
  if(!text) return;
  csrftoken = csrftoken || getCookie('csrftoken') || document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || '';
  try {
    const res = await fetch(MESSAGES_URL, { method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':csrftoken}, body: JSON.stringify({text,tab:activeTab,avatar:selectedAvatar}) });
    if(!res.ok){ const errText=await res.text().catch(()=>null); throw new Error(errText||res.status); }
    const data = await res.json();
    appendMessage(data.message);
    input.value='';
  } catch(err){ alert('No se pudo enviar el mensaje'); console.error(err); }
}

document.getElementById('sendBtn').addEventListener('click', sendMessage);
document.getElementById('msgInput').addEventListener('keypress', e=>{ if(e.key==='Enter') sendMessage(); });

/* datetime */
function updateDateTime(){
  const now = new Date();
  const d=String(now.getDate()).padStart(2,'0');
  const m=String(now.getMonth()+1).padStart(2,'0');
  const y=now.getFullYear();
  const hh=String(now.getHours()).padStart(2,'0');
  const mm=String(now.getMinutes()).padStart(2,'0');
  document.getElementById('datetime').textContent=`${d}/${m}/${y} ${hh}:${mm}`;
}
updateDateTime();
setInterval(updateDateTime,60000);

/* inicial carga mensajes */
loadMessages(activeTab);
</script>

</body>
</html>
